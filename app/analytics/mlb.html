<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MLB Analytics | SportsAnalytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js" defer></script>
  <style>
    .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05) }
    .tab-btn { border-bottom: 3px solid transparent }
    .tab-active { border-bottom-color: #6366f1; color: #6366f1; font-weight: 600 }
    .chart-container { position: relative; height: 400px; width: 100% }
  </style>
</head>
<body class="bg-gray-50">
  <div class="bg-indigo-200 text-white">
    <nav class="container mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <img src="images/MasterTrident-transparent.png" alt="Logo" class="h-10 w-10">
          <span class="text-xl font-bold">PLONN Analytics</span>
        </div>
        <div class="hidden md:flex items-center space-x-8">
          <a href="nba.html" class="text-gray-100/80 hover:text-white">NBA</a>
          <a href="mlb.html" class="text-white font-medium">MLB</a>
          <a href="index.html" class="px-4 py-2 bg-indigo-600 rounded-lg hover:bg-indigo-700 transition">Home</a>
        </div>
        <button id="menuBtn" class="md:hidden focus:outline-none"><i data-feather="menu" class="w-6 h-6"></i></button>
      </div>
      <div id="mobileMenu" class="md:hidden mt-3 hidden">
        <a href="index.html" class="block py-2 text-white/90 hover:text-white">Home</a>
        <a href="nba.html" class="block py-2 text-white/90 hover:text-white">NBA</a>
        <a href="mlb.html" class="block py-2 text-white font-semibold">MLB</a>
      </div>
    </nav>

    <header class="container mx-auto px-6 py-12">
      <div class="flex flex-col md:flex-row items-center">
        <div class="md:w-1/2 mb-8 md:mb-0">
          <h1 class="text-4xl md:text-5xl font-bold mb-4">MLB Analytics Dashboard</h1>
          <p class="text-lg text-indigo-100 mb-6">Interactive analysis of totals, O/U performance, and team trends.</p>
        </div>
        <div class="h- flex items-center justify-center">
          <i data-feather="bar-chart" class="w-16 h-16 text-white"></i>
        </div>
      </div>
    </header>
  </div>

  <main class="container mx-auto px-6 py-10">
    <!-- Tabs -->
    <div class="flex overflow-x-auto mb-6 border-b border-gray-200 gap-2">
      <button data-tab="overview" class="tab-btn px-6 py-3 mr-2 font-medium text-gray-700 tab-active">Overview</button>
      <button data-tab="scoring"  class="tab-btn px-6 py-3 mr-2 font-medium text-gray-700">Scoring</button>
      <button data-tab="teams"    class="tab-btn px-6 py-3 mr-2 font-medium text-gray-700">Team Trends</button>
      <button data-tab="trend"    class="tab-btn px-6 py-3 font-medium text-gray-700">Series Trends</button>
    </div>

    <!-- KPI + Filters -->
    <section class="mb-8">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-6">
        <div class="stat-card bg-white p-6 rounded-lg shadow">
          <h3 class="font-medium text-gray-700 mb-2">Total Games</h3>
          <p class="text-2xl font-bold text-blue-600" id="total-games">0</p>
        </div>
        <div class="stat-card bg-white p-6 rounded-lg shadow">
          <h3 class="font-medium text-gray-700 mb-2">Average Runs</h3>
          <p class="text-2xl font-bold text-green-600" id="avg-runs">0.00</p>
        </div>
        <div class="stat-card bg-white p-6 rounded-lg shadow">
          <h3 class="font-medium text-gray-700 mb-2">Over % (Actual vs DK)</h3>
          <p class="text-2xl font-bold text-purple-600" id="over-percentage">0%</p>
        </div>
        <div class="stat-card bg-white p-6 rounded-lg shadow">
          <h3 class="font-medium text-gray-700 mb-2">W % (Played)</h3>
          <p class="text-2xl font-bold text-orange-600" id="win-percentage">-</p>
        </div>
        <div class="stat-card bg-white p-6 rounded-lg shadow">
          <h3 class="font-medium text-gray-700 mb-2">Top-Flipped Win %</h3>
          <p class="text-2xl font-bold text-indigo-600" id="top-flipped-win">-</p>
          <p class="text-sm text-gray-500" id="top-flipped-count">0 played</p>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div class="w-full md:w-60">
            <label class="block text-sm font-medium text-gray-700 mb-1">Team</label>
            <select id="team-select" class="w-full"><option value="">All Teams</option></select>
          </div>
          <div class="w-full md:w-48">
            <label class="block text-sm font-medium text-gray-700 mb-1">Month</label>
            <select id="date-range" class="w-full">
              <option value="">All</option><option value="05">May</option><option value="06">June</option>
              <option value="07">July</option><option value="08">August</option><option value="09">September</option>
            </select>
          </div>
          <div class="w-full md:w-48">
            <label class="block text-sm font-medium text-gray-700 mb-1">Result</label>
            <select id="result-select" class="w-full">
              <option value="">All</option><option value="W">W</option><option value="L">L</option><option value="V">V</option>
            </select>
          </div>
          <div class="w-full md:w-auto">
            <label class="block text-sm font-medium text-gray-700 mb-1">Series Options</label>
            <div class="flex items-center gap-3">
              <span class="text-sm">Window</span>
              <select id="series-window" class="w-20">
                <option>1</option><option>2</option><option>3</option><option selected>4</option><option>5</option><option>6</option><option>7</option>
              </select>
              <label class="text-sm flex items-center gap-2"><input id="series-smooth" type="checkbox" checked> Smooth</label>
              <label class="text-sm flex items-center gap-2"><input id="series-tanh" type="checkbox"> tanh</label>
              <label class="text-sm flex items-center gap-2"><input id="series-toponly" type="checkbox" checked> Top game only</label>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- OVERVIEW -->
    <section id="tab-overview" class="tab-panel">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Total Runs Distribution</h2>
          <div class="chart-container"><canvas id="runsChart"></canvas></div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Over/Under Performance</h2>
          <div class="chart-container"><canvas id="ouChart"></canvas></div>
        </div>
      </div>
    </section>

    <!-- SCORING -->
    <section id="tab-scoring" class="tab-panel hidden">
      <div class="bg-white rounded-lg shadow p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Team Performance (Avg Total Runs)</h2>
        <div class="chart-container"><canvas id="teamChart"></canvas></div>
      </div>
    </section>

    <!-- TEAMS (O/U streaks) -->
    <section id="tab-teams" class="tab-panel hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">Team O/U Streaks (Current)</h2>
        <div class="flex gap-3 items-center">
          <label class="text-sm text-gray-600">Type</label>
          <select id="ou-streak-type" class="border rounded px-2 py-1">
            <option value="all" selected>All</option>
            <option value="O">Over streaks</option>
            <option value="U">Under streaks</option>
          </select>
          <label class="text-sm text-gray-600">Min</label>
          <select id="ou-streak-min" class="border rounded px-2 py-1">
            <option>1</option><option selected>2</option><option>3</option><option>4</option><option>5</option>
          </select>
        </div>
      </div>
      <div id="ou-streaks-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <!-- TREND -->
    <section id="tab-trend" class="tab-panel hidden">
      <div class="bg-white rounded-lg shadow p-6 mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Series Over/Under Trend</h2>
        <div class="chart-container"><canvas id="seriesChart"></canvas></div>
      </div>
      <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Monthly summary (Over %)</h3>
        <div class="chart-container" style="height:180px;"><canvas id="monthlyBar"></canvas></div>
      </div>
    </section>

    <!-- TABLE -->
    <section class="bg-white rounded-lg shadow p-6 mt-10">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-800">Game Data</h2>
        <div class="text-sm text-gray-500" id="game-count">Showing 0 games</div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teams</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Runs</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DK Line</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">O/U</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Result</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200" id="game-data"></tbody>
        </table>
        <div class="flex justify-between items-center mt-4 text-sm text-gray-600">
          <button id="prev-page" class="px-3 py-1 bg-indigo-500 text-white rounded disabled:opacity-50">Previous</button>
          <span id="page-info">Page 1</span>
          <button id="next-page" class="px-3 py-1 bg-indigo-500 text-white rounded disabled:opacity-50">Next</button>
        </div>
      </div>
    </section>
  </main>

  <footer class="bg-gray-800 text-white py-10 mt-12">
    <div class="container mx-auto px-6 text-center text-gray-400">© 2023 SportsAnalytics. All rights reserved.</div>
  </footer>

  <script>
  /* CONFIG */
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS4qdht_9LDi4kLspbiQjOKFIdaEtYX0qW99FbOSKK3jhkCIl8xjmJQUMRuBm75liAoFyPZVp4ZJsmk/pub?gid=444068099&single=true&output=csv";

  /* GLOBALS */
  let gameData = [];
  let runsChart, ouChart, teamChart, seriesChart, monthlyBar;
  let currentPage = 1; const pageSize = 15;
  let lastFiltered = []; // <-- single source of truth

  /* TABS */
  const tabButtons = () => [...document.querySelectorAll('.tab-btn')];
  const tabPanels  = () => [...document.querySelectorAll('.tab-panel')];
  function switchTab(name){
    tabButtons().forEach(b=>b.classList.toggle('tab-active', b.dataset.tab===name));
    tabPanels().forEach(p=>p.classList.toggle('hidden', p.id !== 'tab-'+name));
  }
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('.tab-btn'); if(!btn) return;
    switchTab(btn.dataset.tab);

    if (window.runsChart) runsChart.update();
    if (window.ouChart) ouChart.update();
    if (window.teamChart) teamChart.update();

    // Force reflow when Trend tab becomes visible
    if (btn.dataset.tab === 'trend') {
      setTimeout(()=>{
        if (window.seriesChart){ seriesChart.resize(); seriesChart.update(); }
        if (window.monthlyBar){ monthlyBar.resize(); monthlyBar.update(); }
      }, 0);
    }
  });

  /* HELPERS */
  const normHeader = h => String(h||'').trim().replace(/^\uFEFF/,'').toLowerCase().replace(/\s+/g,'_').replace(/[^\w_]/g,'');
  function parseCSV(text){
    const lines = text.replace(/\r\n/g,'\n').split('\n').filter(l=>l.trim().length>0);
    if(!lines.length) return {headers:[],rows:[]};
    const splitter = /,(?=(?:[^"]*"[^"]*")*[^"]*$)/;
    const headers = lines.shift().split(splitter).map(c=>c.trim().replace(/^"|"$/g,'')).map(normHeader);
    const rows = lines.map(line=>{
      const cells = line.split(splitter).map(c=>c.trim().replace(/^"|"$/g,''));
      const o={}; headers.forEach((h,i)=>o[h] = (cells[i] ?? '').trim()); return o;
    });
    return {headers,rows};
  }
  const toNum = v => {
    if (typeof v==='number') return Number.isFinite(v)?v:null;
    if (v==null) return null;
    const s = String(v).trim(); if(!s) return null;
    const n = Number(s.replace(/[^0-9.\-]/g,''));
    return Number.isFinite(n)?n:null;
  };
  function toDate(s){
    if(!s) return null;
    const d = new Date(s);
    if(!isNaN(d.getTime())) return d;
    const p = String(s).split(/[\/\-]/).map(x=>x.trim());
    if(p.length===3){ let mm=+p[0], dd=+p[1], yy=+p[2]; if(yy<100) yy+=2000; const d2=new Date(yy,mm-1,dd); if(!isNaN(d2.getTime())) return d2; }
    return null;
  }
  function inferWL(ou, dk, actual){
    if(!ou || !Number.isFinite(dk) || !Number.isFinite(actual)) return '';
    if (actual===dk) return 'V';
    if ((ou==='O' && actual>dk) || (ou==='U' && actual<dk)) return 'W';
    return 'L';
  }
  function getField(obj, candidates) {
    for (const c of candidates) {
      if (obj[c] !== undefined && String(obj[c]).trim() !== '') return obj[c];
    }
    return '';
  }

  /* CHART INIT */
  function initCharts(){
    runsChart = new Chart(document.getElementById('runsChart').getContext('2d'), {
      type:'bar',
      data:{labels:['0-3','4-6','7-9','10-12','13+'],datasets:[{label:'Games',data:[0,0,0,0,0]}]},
      options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}
    });
    ouChart = new Chart(document.getElementById('ouChart').getContext('2d'), {
      type:'doughnut',
      data:{labels:['Over %','Under %','Push %'],datasets:[{data:[0,0,0]}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right'}}}
    });
    teamChart = new Chart(document.getElementById('teamChart').getContext('2d'), {
      type:'bar', data:{labels:[],datasets:[{label:'Average Total Runs',data:[]}]},
      options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true}}}
    });
    seriesChart = new Chart(document.getElementById('seriesChart').getContext('2d'), {
      type:'line', data:{labels:[],datasets:[{label:'Series O/U Score',data:[],fill:true,tension:.4}]},
      options:{responsive:true,maintainAspectRatio:false,scales:{y:{min:-1,max:1}}}
    });
    monthlyBar = new Chart(document.getElementById('monthlyBar').getContext('2d'), {
      type:'bar',
      data:{labels:[],datasets:[
        {label:'Over % (Predicted)',data:[]},
        {label:'Over (Actual Wins) %',data:[]}
      ]},
      options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,max:100}}}
    });
  }

  /* TOP GAME PER DATE */
  function getTopGamesPerDate(games){
    const byDate = {};
    games.forEach(g=>{
      const key = g.dateObj? g.dateObj.toISOString().slice(0,10) : (g.date||'');
      (byDate[key] ||= []).push(g);
    });
    const tops = Object.keys(byDate).map(d=>{
      const list = byDate[d].slice().sort((a,b)=>{
        const ar = Number.isFinite(a.totalRun)?a.totalRun:-1e9;
        const br = Number.isFinite(b.totalRun)?b.totalRun:-1e9;
        if(br!==ar) return br-ar;
        const aa = Number.isFinite(a.totalActual)?a.totalActual:-1e9;
        const ba = Number.isFinite(b.totalActual)?b.totalActual:-1e9;
        return ba-aa;
      });
      return list[0];
    });
    return tops.sort((a,b)=>a.dateObj-b.dateObj);
  }

  /* DK-only O/U streaks (MLB) */
  function computeTeamOUStreaks_MLB(games) {
    const perTeam = new Map();
    games.forEach(g => {
      if (!g?.dateObj) return;
      if (!Number.isFinite(g.dkLine) || !Number.isFinite(g.totalActual)) return;

      const ou = g.totalActual > g.dkLine ? 'O' : g.totalActual < g.dkLine ? 'U' : 'V';
      if (ou === 'V') return;

      const rec = { dateObj: g.dateObj, date: g.date, ou };
      const t1 = g.team1, t2 = g.team2;
      if (t1) { (perTeam.get(t1) || perTeam.set(t1, []).get(t1)).push(rec); }
      if (t2) { (perTeam.get(t2) || perTeam.set(t2, []).get(t2)).push(rec); }
    });

    const out = [];
    for (const [team, arr] of perTeam) {
      if (!arr.length) continue;
      arr.sort((a,b)=> b.dateObj - a.dateObj);
      const type = arr[0].ou;
      let length = 0, lastDate = arr[0].date;
      for (const r of arr) { if (r.ou !== type) break; length++; }
      out.push({ team, type, length, lastDate });
    }
    out.sort((a,b)=> b.length - a.length || (a.type === 'O' ? -1 : 1) || a.team.localeCompare(b.team));
    return out;
  }

  function renderOUStreakGrid_MLB(streaks) {
    const grid = document.getElementById('ou-streaks-grid');
    if (!grid) return;

    const want = (document.getElementById('ou-streak-type')?.value || 'all');
    const min  = +(document.getElementById('ou-streak-min')?.value || 2);

    const filt = (streaks || []).filter(s => s.length >= min && (want === 'all' || s.type === want));
    grid.innerHTML = filt.length ? '' : '<div class="text-gray-500">No teams meet the filter.</div>';

    filt.slice(0, 12).forEach(s => {
      const badge = s.type === 'O' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
      const card = document.createElement('div');
      card.className = 'bg-white p-4 rounded-lg shadow flex items-center justify-between';
      card.innerHTML = `
        <div>
          <h3 class="font-bold text-gray-900">${s.team}</h3>
          <p class="text-sm text-gray-600">Last: ${s.lastDate || '-'}</p>
        </div>
        <div class="text-right">
          <div class="text-3xl font-bold">${s.length}<span class="text-base font-semibold ml-1">${s.type}</span></div>
          <span class="px-2 py-0.5 mt-1 inline-block text-xs rounded ${badge}">
            ${s.type === 'O' ? 'Over' : 'Under'} streak
          </span>
        </div>`;
      grid.appendChild(card);
    });
  }

  function updateOUStreakHeadline_MLB(team, streaks) {
    const head = document.getElementById('ou-streak-headline');
    const sub  = document.getElementById('ou-streak-sub');
    if (!head || !sub) return;
    let pick = team ? (streaks || []).find(s => s.team === team) : null;
    if (!pick) pick = (streaks || [])[0];
    if (!pick) { head.textContent = '—'; sub.textContent = 'No O/U streaks found'; return; }
    head.textContent = `${pick.team}: ${pick.length}${pick.type}`;
    sub.textContent  = `Using DK line vs actual • last game: ${pick.lastDate || '-'}`;
  }

  /* SERIES SCORE */
  function computeSeriesScore(rows, windowSize=4, smooth=true, tanh=false){
    const sorted = rows.slice().sort((a,b)=>a.dateObj-b.dateObj);
    const ouVal = g => g.ou==='O'?1 : (g.ou==='U'?-1:0);
    const raw = [];
    for(let i=0;i<=sorted.length-windowSize;i++){
      const win = sorted.slice(i,i+windowSize);
      const vals = win.map(ouVal).filter(v=>v!==0);
      const score = vals.length? vals.reduce((s,v)=>s+v,0)/vals.length : 0;
      raw.push({label: win[Math.floor(windowSize/2)]?.date || '', value: score});
    }
    let data = raw.map(r=>r.value);
    if (smooth && data.length>=3){
      const s=[]; for(let i=0;i<data.length;i++){const a=Math.max(0,i-1), b=Math.min(data.length-1,i+1); const slice=data.slice(a,b+1); s[i]=slice.reduce((x,y)=>x+y,0)/slice.length;}
      data = s;
    }
    if (tanh) data = data.map(x=>Math.tanh(x*2));
    return {labels: raw.map(r=>r.label), values: data};
  }

  /* FILTERS + CHART UPDATE */
  function filterData(){
    const team = document.getElementById('team-select').value;
    const month = document.getElementById('date-range').value;
    const result = document.getElementById('result-select').value;

    let filtered = gameData.slice().sort((a,b)=>b.dateObj-a.dateObj);
    if (team)  filtered = filtered.filter(g=>g.team1===team || g.team2===team);
    if (month) filtered = filtered.filter(g=>(g.date||'').split('-')[1]===month);
    if (result) filtered = filtered.filter(g=>g.wl===result);

    lastFiltered = filtered.slice();            // keep latest set
    currentPage = 1;
    updateCharts(lastFiltered);
    updateSeriesCharts(lastFiltered, team);

    try { updateOUStreakHeadline_MLB(team, window.ouStreaksAll || []); } catch(e) {
      console.warn('[MLB] OU streak headline update skipped:', e);
    }
  }

  function updateCharts(filtered){
    document.getElementById('total-games').textContent = filtered.length;

    const played = filtered.filter(g=>Number.isFinite(g.totalActual));
    const avg = played.length ? played.reduce((s,g)=>s+g.totalActual,0)/played.length : 0;
    document.getElementById('avg-runs').textContent = avg.toFixed(2);

    const ouRows = filtered.filter(g=>Number.isFinite(g.totalActual)&&Number.isFinite(g.dkLine));
    let over=0,under=0,push=0;
    ouRows.forEach(g=>{
      if (g.totalActual>g.dkLine) over++; else if (g.totalActual<g.dkLine) under++; else push++;
    });
    const denom = ouRows.length || 1;
    const overPct = Math.round(over/denom*100);
    const underPct= Math.round(under/denom*100);
    const pushPct = Math.round(push/denom*100);
    document.getElementById('over-percentage').textContent = `${overPct}%`;
    ouChart.data.datasets[0].data = [overPct,underPct,pushPct]; ouChart.update();

    const wins = filtered.filter(g=>g.wl==='W').length;
    const playedWL = filtered.filter(g=>['W','L','V'].includes(g.wl)).length;
    document.getElementById('win-percentage').textContent = playedWL? `${Math.round(wins/playedWL*100)}%` : '-';

    const bins=[0,0,0,0,0];
    played.forEach(g=>{
      const r=g.totalActual;
      if (r<=3) bins[0]++; else if (r<=6) bins[1]++; else if (r<=9) bins[2]++; else if (r<=12) bins[3]++; else bins[4]++;
    });
    runsChart.data.datasets[0].data = bins; runsChart.update();

    const teamStats={};
    played.forEach(g=>{
      if(g.team1){(teamStats[g.team1] ||= {sum:0,n:0}); teamStats[g.team1].sum+=g.totalActual; teamStats[g.team1].n++;}
      if(g.team2){(teamStats[g.team2] ||= {sum:0,n:0}); teamStats[g.team2].sum+=g.totalActual; teamStats[g.team2].n++;}
    });
    const labels = Object.keys(teamStats);
    teamChart.data.labels = labels;
    teamChart.data.datasets[0].data = labels.map(t=>+(teamStats[t].sum/teamStats[t].n).toFixed(2));
    teamChart.update();

    // Table + pagination
    const tbody = document.getElementById('game-data'); tbody.innerHTML='';
    const start=(currentPage-1)*pageSize, end=start+pageSize;
    const pageRows = filtered.slice(start,end);
    pageRows.forEach(g=>{
      const resultBadge = g.wl==='W'?'bg-green-100 text-green-800':(g.wl==='L'?'bg-red-100 text-red-800':'bg-gray-100 text-gray-800');
      const tr=document.createElement('tr');
      tr.className='hover:bg-gray-50';
      tr.innerHTML = `
        <td class="px-6 py-3 text-sm text-gray-500">${g.date||'-'}</td>
        <td class="px-6 py-3 text-sm font-medium text-gray-900">${g.team1||'-'} vs ${g.team2||'-'}</td>
        <td class="px-6 py-3 text-sm text-gray-500">${Number.isFinite(g.totalActual)?g.totalActual:'-'}</td>
        <td class="px-6 py-3 text-sm text-gray-500">${g.dkLine ?? ''}</td>
        <td class="px-6 py-3 text-sm text-gray-500">${g.ou||''}</td>
        <td class="px-6 py-3"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${resultBadge}">${g.wl||'-'}</span></td>
      `;
      tbody.appendChild(tr);
    });
    document.getElementById('game-count').textContent = `Showing ${pageRows.length} of ${filtered.length} games`;
    document.getElementById('page-info').textContent = `Page ${currentPage} of ${Math.max(1,Math.ceil(filtered.length/pageSize))}`;
    document.getElementById('prev-page').disabled = currentPage===1;
    document.getElementById('next-page').disabled = currentPage*pageSize>=filtered.length;

    document.getElementById('prev-page').onclick = ()=>{ if(currentPage>1){ currentPage--; updateCharts(filtered);} };
    document.getElementById('next-page').onclick = ()=>{ if(currentPage*pageSize<filtered.length){ currentPage++; updateCharts(filtered);} };
  }

  function updateSeriesCharts(filtered, teamFilter){
    let base = filtered.slice().filter(g=>g.dateObj && Number.isFinite(g.totalActual));
    if (teamFilter) base = base.filter(g=>g.team1===teamFilter || g.team2===teamFilter);

    base = base.map(g=>{
      const baseline = Number.isFinite(g.dkLine)?g.dkLine : (Number.isFinite(g.totalRun)?g.totalRun:null);
      let ou = g.ou;
      if (baseline!=null){
        if (g.totalActual>baseline) ou='O'; else if (g.totalActual<baseline) ou='U'; else ou='';
      }
      return {...g, ou, _baseline: baseline};
    });

    const topOnly = document.getElementById('series-toponly').checked;
    const source = topOnly? getTopGamesPerDate(base) : base.slice().sort((a,b)=>a.dateObj-b.dateObj);

    const win = Math.min(7, Math.max(1, +document.getElementById('series-window').value || 4));
    const smooth = document.getElementById('series-smooth').checked;
    const tanh = document.getElementById('series-tanh').checked;

    if (source.length >= win){
      const s = computeSeriesScore(source, win, smooth, tanh);
      seriesChart.data.labels = s.labels;
      seriesChart.data.datasets[0].data = s.values;
      seriesChart.update();
    } else {
      seriesChart.data.labels = [];
      seriesChart.data.datasets[0].data = [];
      seriesChart.update();
    }

    const months = {};
    base.forEach(g=>{
      if(g._baseline==null) return;
      const key = `${g.dateObj.getFullYear()}-${String(g.dateObj.getMonth()+1).padStart(2,'0')}`;
      if (!months[key]) months[key] = {count:0, over:0, overWins:0};
      months[key].count++;
      const isOver = g.totalActual > g._baseline;
      if (isOver) months[key].over++;
      if (isOver && g.wl==='W') months[key].overWins++;
    });
    const keys = Object.keys(months).sort();
    monthlyBar.data.labels = keys;
    monthlyBar.data.datasets[0].data = keys.map(k=> months[k].count? +(months[k].over/months[k].count*100).toFixed(1):0 );
    monthlyBar.data.datasets[1].data = keys.map(k=> months[k].count? +(months[k].overWins/months[k].count*100).toFixed(1):0 );
    monthlyBar.update();
  }

  /* BOOT */
  document.addEventListener('DOMContentLoaded', async ()=>{
    if(window.AOS) AOS.init({duration:800, once:true});
    if(window.feather) feather.replace();
    document.getElementById('menuBtn')?.addEventListener('click', ()=>document.getElementById('mobileMenu')?.classList.toggle('hidden'));

    initCharts();

    try{
      const resp = await fetch(CSV_URL, {cache:'no-store'});
      if (!resp.ok) {
        console.error('[MLB] CSV fetch failed', resp.status, resp.statusText);
        document.getElementById('game-count').textContent = 'CSV fetch failed';
        return;
      }
      const text = await resp.text();
      const parsed = parseCSV(text); const rows = parsed.rows||[];
      const now = new Date(); const todayEnd = new Date(now.getFullYear(),now.getMonth(),now.getDate(),23,59,59,999);

      // tolerant mapping
      gameData = rows.map(r => {
        const dateRaw = getField(r, ['date','date_iso','game_date','dategame']);
        const d = toDate(dateRaw);
        const iso = d ? d.toISOString().slice(0,10) : '';

        const team1 = (getField(r, ['team_1','team1','team_home','team_home_name','home','home_team']) || '').trim();
        const team2 = (getField(r, ['team_2','team2','team_away','team_away_name','away','away_team']) || '').trim();

        const totalRun = toNum(getField(r, ['total_run','predicted_total','pred_total','totalrun','total','predicted_runs']));
        const dk       = toNum(getField(r, ['dk_line','dkline','dk','dk_lines','dk_line_total']));
        const actual   = toNum(getField(r, ['total_actual','actual_total','actual','total_runs','total_score']));

        const ouRaw = String(getField(r, ['o_u','ou','o/u','over_under','o_u_flag'])).trim().toUpperCase();
        const ou = (ouRaw === 'O' || ouRaw === 'OVER') ? 'O' : (ouRaw === 'U' || ouRaw === 'UNDER') ? 'U' : '';

        const isPlayed = d && d <= todayEnd && Number.isFinite(actual);

        return {
          date: iso || (dateRaw || ''),
          dateObj: d || null,
          team1, team2,
          totalRun: Number.isFinite(totalRun) ? +totalRun.toFixed(2) : null,
          dkLine: dk ?? null,
          totalActual: Number.isFinite(actual) ? actual : null,
          ou,
          wl: isPlayed ? inferWL(ou, dk, actual) : ''
        };
      });

      // O/U streaks (league-wide)
      window.ouStreaksAll = computeTeamOUStreaks_MLB(gameData);
      console.log('[MLB] DK+Actual rows:', gameData.filter(g => Number.isFinite(g.dkLine) && Number.isFinite(g.totalActual)).length);
      console.log('[MLB] O/U streak teams:', window.ouStreaksAll.length);

      renderOUStreakGrid_MLB(window.ouStreaksAll);
      updateOUStreakHeadline_MLB('', window.ouStreaksAll);

      document.getElementById('ou-streak-type')?.addEventListener('change', () => renderOUStreakGrid_MLB(window.ouStreaksAll));
      document.getElementById('ou-streak-min')?.addEventListener('change',  () => renderOUStreakGrid_MLB(window.ouStreaksAll));

      // Populate team filter
      const teamEl = document.getElementById('team-select');
      const teams = new Set(); gameData.forEach(g=>{ if(g.team1) teams.add(g.team1); if(g.team2) teams.add(g.team2); });
      [...teams].sort().forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; teamEl.appendChild(o); });
      if (window.TomSelect) new TomSelect('#team-select', { create:false, sortField:'text' });

      // Initial renders
      switchTab('overview');
      lastFiltered = gameData.slice().sort((a,b)=>b.dateObj - a.dateObj);
      updateCharts(lastFiltered);
      updateSeriesCharts(lastFiltered, '');

      // Wire filter & series controls
      document.getElementById('team-select').addEventListener('change', ()=>{ currentPage=1; filterData(); });
      document.getElementById('date-range').addEventListener('change', ()=>{ currentPage=1; filterData(); });
      document.getElementById('result-select').addEventListener('change', ()=>{ currentPage=1; filterData(); });

      ['series-window','series-smooth','series-tanh','series-toponly'].forEach(id=>{
        document.getElementById(id).addEventListener('change', ()=>{
          const team = document.getElementById('team-select').value || '';
          updateSeriesCharts(lastFiltered, team); // recompute from current filtered set
        });
      });

    }catch(e){
      console.error('[MLB] error loading/parsing CSV:', e);
      document.getElementById('game-count').textContent = 'Error loading CSV';
    }
  });
  </script>
</body>
</html>
